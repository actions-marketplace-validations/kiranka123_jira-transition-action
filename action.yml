name: 'Jira Transition on PR Merge'
description: 'Transitions a Jira issue to QA when a PR is merged into develop by extracting the Jira link from the PR body.'
author: 'Your Name or Org'

runs:
  using: 'composite'
  steps:
    - name: Extract Jira Ticket and Transition
      shell: bash
      run: |
        set -e

        BODY=$(echo "${{ env.PR_BODY }}" | tr -d '\r')
        TICKET_ID=$(echo "$BODY" | grep -oE 'https://[a-zA-Z0-9.-]+/browse/([A-Z]+-[0-9]+)' | grep -oE '[A-Z]+-[0-9]+')

        if [ -z "$TICKET_ID" ]; then
          echo "‚ùå No Jira ticket found in PR body. Skipping transition."
          exit 0
        fi

        echo "‚úÖ Jira Ticket ID detected: $TICKET_ID"
        echo "üöÄ Sending transition request to Jira..."

        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
          -u "${{ env.JIRA_EMAIL }}:${{ env.JIRA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --url "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/${TICKET_ID}/transitions" \
          -d "{\"transition\": {\"id\": \"${{ env.JIRA_TRANSITION_ID }}\"}}")

        if [ "$RESPONSE" == "204" ]; then
          echo "‚úÖ Jira issue $TICKET_ID transitioned successfully."
        else
          echo "‚ùå Jira transition failed. HTTP response: $RESPONSE"
          exit 1
        fi

branding:
  icon: 'repeat'
  color: 'blue'

